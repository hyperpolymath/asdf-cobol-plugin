#!/usr/bin/env bash
# SPDX-License-Identifier: AGPL-3.0-or-later
# shellcheck shell=bash

set -euo pipefail

current_script_path="${BASH_SOURCE[0]}"
plugin_dir="$(dirname "$(dirname "$current_script_path")")"

# shellcheck source=../lib/utils.bash
source "${plugin_dir}/lib/utils.bash"

install_type="${ASDF_INSTALL_TYPE:?}"
install_version="${ASDF_INSTALL_VERSION:?}"
install_path="${ASDF_INSTALL_PATH:?}"
download_path="${ASDF_DOWNLOAD_PATH:?}"
concurrency="${ASDF_CONCURRENCY:-$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 1)}"

if [[ "$install_type" != "version" ]]; then
  fail "asdf-cobol supports release versions only (not refs)"
fi

# GnuCOBOL build dependencies:
# - A C compiler (gcc or clang)
# - libgmp-dev (GNU Multiple Precision library)
# - libdb-dev (Berkeley DB, optional)
# - libncurses-dev (for screen handling)
# - libcjson-dev (for JSON support, optional)
# - libxml2-dev (for XML support, optional)

check_dependencies() {
  local missing=()

  if ! command -v gcc &>/dev/null && ! command -v clang &>/dev/null; then
    missing+=("C compiler (gcc or clang)")
  fi

  if ! command -v make &>/dev/null; then
    missing+=("make")
  fi

  if [[ ${#missing[@]} -gt 0 ]]; then
    printf 'Missing required build dependencies:\n' >&2
    for dep in "${missing[@]}"; do
      printf '  - %s\n' "$dep" >&2
    done
    printf '\nOn Debian/Ubuntu: sudo apt-get install build-essential libgmp-dev libncurses-dev\n' >&2
    printf 'On Fedora/RHEL:   sudo dnf install gcc make gmp-devel ncurses-devel\n' >&2
    printf 'On macOS:         brew install gmp ncurses\n' >&2
    printf 'On Guix:          guix install gcc-toolchain gmp ncurses\n' >&2
    return 1
  fi
}

build_gnucobol() {
  local source_dir="$1"
  local target_dir="$2"

  cd "$source_dir"

  printf 'Configuring GnuCOBOL %s...\n' "$install_version"

  # Configure with prefix
  # Note: Some optional features may fail if their deps aren't installed
  # We continue anyway as core functionality will work
  ./configure --prefix="$target_dir" \
    --disable-rpath \
    2>&1

  printf 'Building GnuCOBOL %s with %s parallel jobs...\n' "$install_version" "$concurrency"
  make -j "$concurrency" 2>&1

  printf 'Installing GnuCOBOL %s to %s...\n' "$install_version" "$target_dir"
  make install 2>&1
}

verify_installation() {
  local bin_path="$1/bin/cobc"

  if [[ ! -x "$bin_path" ]]; then
    fail "Installation failed: cobc binary not found at $bin_path"
  fi

  local installed_version
  installed_version="$("$bin_path" --version 2>&1 | head -n1 | grep -oE '[0-9]+\.[0-9]+(\.[0-9]+)?' || true)"

  if [[ -n "$installed_version" ]]; then
    printf 'Successfully installed GnuCOBOL %s\n' "$installed_version"
  else
    printf 'GnuCOBOL installed (could not verify version)\n'
  fi
}

# Main installation logic
printf 'Installing GnuCOBOL %s\n' "$install_version"

check_dependencies

# Create install directory
mkdir -p "$install_path"

# Build and install
if build_gnucobol "$download_path" "$install_path"; then
  verify_installation "$install_path"
else
  # Clean up partial installation on failure
  rm -rf "$install_path"
  fail "Failed to build GnuCOBOL ${install_version}"
fi
